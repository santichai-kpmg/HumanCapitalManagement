
@{


    ViewBag.Title = "HCM | Trainee Perdiem/Transport";
    Layout = "~/Views/Shared/_LPMaster.cshtml";
}



<!-- Content Header (Page header) -->
<section class="content-header">
    <h1>
        Trainee Perdiem/Transport
    </h1>
    <div class="row">
        <div class="box box-solid">
            <div class="box-body no-border no-pad-top no-pad-bot">
                <div class="row" id="search">
                    @*<div class="form-group form-group-sm col-sm-4  col-xs-4">
                            <div class="input-group">
                                <span class="input-group-addon nomallabel">Group</span>
                                @{ Html.RenderAction("CreateDivisionCode", "HCMMasterData", new
                                    {
                                        id = "ddlGroup",
                                        databind = "group_code",
                                        value = ""
                                    });}
                            </div>
                        </div>*@
                    <br />
                    <div class="form-group form-group-sm col-sm-4  col-xs-4">
                        <div class="input-group">
                            <span class="input-group-addon nomallabel">Trainee Name</span>
                            <input type="text" id="txtSearch" name="txtSearch" class="form-control" data-bind="value : name , valueUpdate: 'afterkeydown'" autocomplete="off" />
                        </div>
                    </div>

                    <div class="form-group form-group-sm col-sm-4  col-xs-4 hidden">
                        <div class="input-group">
                            <span class="input-group-addon nomallabel">Trainee No.</span>
                            <input type="text" id="txtSearchNo" name="txtSearchNo" class="form-control" data-bind="value : no , valueUpdate: 'afterkeydown'" autocomplete="off" />
                        </div>
                    </div>

                    @*<div class="form-group form-group-sm col-sm-4  col-xs-4">
                            <div class="input-group">
                                <span class="input-group-addon nomallabel">PM’s Name</span>
                                <input type="text" id="txtSearchpm" name="txtSearchpm" class="form-control" data-bind="value : eva_name , valueUpdate: 'afterkeydown'" autocomplete="off" />
                            </div>
                        </div>
                        <div class="form-group form-group-sm col-sm-4  col-xs-4">
                            <div class="input-group">
                                <span class="input-group-addon nomallabel">In-Charge/EM’s Name</span>
                                <input type="text" id="txtSearchEm" name="txtSearchEm" class="form-control" data-bind="value : eva_ic_name , valueUpdate: 'afterkeydown'" autocomplete="off" />
                            </div>
                        </div>*@
                </div>
                <div class="row">
                    <div class="form-group form-group-sm col-xs-12  text-left">
                        <button type="button" class="btn btn-info" onclick="LoadData();">Search</button>
                    </div>
                </div>

            </div>
        </div>
    </div>


</section>

<!-- Main content -->
<div class="collapse in" id="divTable">
    <section class="content no-pad-top ">
        <form class="form-horizontal">
            <div class="row">
                <div class="col-md-12">
                    <!-- general form elements -->
                    <div class="box box-primary">
                        <div class="box-header with-border">
                            Search Results
                            <div class="box-tools pull-right">
                                <button id="btnRefeshTable" type="button" class="btn btn-box-tool" onclick="RefreshTable(this)">
                                    <i class="fa fa-refresh"></i>
                                </button>
                            </div>
                        </div>
                        <!-- /.box-header -->
                        <!-- form start -->
                        <div class="box-body">

                            <div class="row ">
                                <div class="col-md-12">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-bordered table-hover display" id="gvwData">
                                            <thead>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>

                                </div>
                            </div>
                        </div>
                        <!-- /.box-body -->
                    </div>
                </div>
                @*<input type="hidden" id="txtSess" name="txtSess" class="form-control" data-bind='value: session' />*@
            </div>

        </form>
    </section>
</div>

<div id="PopupView" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #337ab7;">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <span class="modal-title">
                    <b style="color: white;">
                        <span class="fa fa-eye"></span>&nbsp; Perdiem / Transport
                    </b>
                </span>
            </div>
            <div class="modal-body text-center">
                <p id="notxt" hidden></p>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group form-group-sm row">
                            <label class="col-sm-4 col-form-label nomallabel text-right">Type of reimbursement </label>
                            <div class="col-sm-5">
                                <select class="form-control input-sm" id="ddlType_of_reimbursement">
                                    <option value="P">Perdiem</option>
                                    <option value="T">Transport</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group form-group-sm row">
                            <label class="col-sm-4 col-form-label nomallabel text-right">Company </label>
                            <div class="col-sm-5">
                                <select class="form-control input-sm" id="ddlCompany">
                                    <option value="1">KPMG Phoomchai Audit Ltd.</option>
                                    <option value="2">KPMG Phoomchai Tax Ltd.</option>
                                    <option value="3">KPMG Phoomchai Business Advisory Ltd.</option>
                                    <option value="4">KPMG Phoomchai Holdings Co., Ltd.</option>
                                    <option value="5">KPMG Consulting (Thailand) Limited</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group form-group-sm row">
                            <label class="col-sm-4 col-form-label nomallabel text-right">Reimbursable  </label>
                            <div class="col-sm-5">
                                <select class="form-control input-sm" id="ddlReimbursable">
                                    <option value="C">Client </option>
                                    <option value="O">Office</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group form-group-sm row">
                            <label class="col-sm-4 col-form-label nomallabel text-right">
                                Business Purpose
                            </label>
                            <div class="col-sm-5">
                                <input type="text" class="form-control input-sm" id="txtBusiness_Purpose" name="txtBusiness_Purpose" maxlength="200">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group form-group-sm row">
                            <label class="col-sm-4 col-form-label nomallabel text-right">
                                Date
                            </label>
                            <div class="col-sm-5">
                                <input type="text" class="form-control input-sm" id="txtdaterange" name="txtdaterange" maxlength="200">

                            </div>
                        </div>
                    </div>

                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group form-group-sm row">
                            <label class="col-sm-4 col-form-label nomallabel text-right">
                                Amount
                            </label>
                            <div class="col-sm-5">
                                <input type="number" class="form-control input-sm" id="txtAmount" name="txtAmount" maxlength="200">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group form-group-sm row">
                            <label class="col-sm-4 col-form-label nomallabel text-right">
                                Engagement Code
                            </label>
                            <div class="col-sm-5">
                                <input id="txtEngagement_Code" name="txtEngagement_Code" class="form-control" type="search" list="engagement_lst" />

                                <datalist id="engagement_lst"></datalist>
                            </div>
                        </div>
                    </div>
                </div>



                <div class="modal-footer">

                    <div id="foredit">
                        <button id="btnOK" type="button" onclick="SaveData('Y')" class="btn btn-primary" data-dismiss="modal">
                            &nbsp; Approve
                        </button>
                        <button type="button" class="btn btn-danger" onclick="Revises()">&nbsp; Revise</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="PopupConfirm_Revise" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog  widthPOP">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #337ab7;">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <span class="modal-title">
                    <b style="color: white;">
                        <span class="fa fa-info-circle"></span>&nbsp; Revise Remark
                    </b>
                </span>
            </div>
            <div class="modal-body text-center">
                <div class="form-group form-group-sm col-sm-12  col-xs-12">
                    <div class="input-group">
                        <span class="input-group-addon nomallabel">Remark</span>
                        <input type="text" id="txtRemark" name="txtRemark" class="form-control" data-bind="value : name , valueUpdate: 'afterkeydown'" autocomplete="off" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btnOK" type="button" onclick="SaveData('R');return false;" class="btn btn-primary" data-dismiss="modal">
                    &nbsp; Revise
                </button>

                <button type="button" class="btn btn-danger" data-dismiss="modal">&nbsp; Cancel</button>
            </div>
        </div>
    </div>
</div>
@section scripts{

    <script src="~/Scripts/plugins/bootstrapValidate/dist/js/bootstrapValidator.js"></script>
    <script src="~/Scripts/plugins/knockout-3.4.2.js"></script>
    <script src="~/Scripts/plugins/knockout.mapping-latest.js"></script>
    <script src="~/Scripts/plugins/jquery-inputmask/min/inputmask/inputmask.min.js"></script>
    <script src="~/Scripts/plugins/jquery-inputmask/min/inputmask/inputmask.numeric.extensions.min.js"></script>
    <script src="~/Scripts/plugins/jquery-inputmask/min/inputmask/jquery.inputmask.min.js"></script>
    <script src="~/Scripts/plugins/jsLinq/linq.min.js"></script>
    <script src="~/Scripts/plugins/jsLinq/jquery.linq.min.js"></script>
    @*<script src="~/Scripts/plugins/DataTables2/dataTables.rowGroup.min.js"></script>*@

    <script src="~/Scripts/plugins/moment/moment.js"></script>

    <script type="text/javascript">
        var objModel = @Html.Raw(Json.Encode(Model));
        $(window).bind("load", function () {
            $('#gvwData').DataTable().columns.adjust().draw();
        });
        $(function () {

            SetTable();
            BindData(objModel);
            ko.applyBindings(viewModel);
        });

        function View_PT(sVal) {
            var lstSearch = ko.toJS(objModel.lstData);
            setReadonly();
            var newdata = [];
            $.each(lstSearch, function (key, value) {
                if (value.Id == sVal) { newdata = value; }
                //alert(key + ": " + value.Id);
            });
            $("#ddlType_of_reimbursement").val(newdata.Type_of_withdrawal);
            $("#ddlCompany").val(newdata.Company);
            $("#ddlReimbursable").val(newdata.Reimbursable);
            $('#txtAmount').val(newdata.Amount);
            $('#txtBusiness_Purpose').val(newdata.Business_Purpose);
            $('#txtdaterange').val(newdata.date_start + ' - ' + newdata.date_end);
            if(newdata.Engagement_Code == null || newdata.Engagement_Code == "")
            {
                 DialogWarning(DialogHeader.Warning, "Engagement Code not found", 'func', function () {

                            return false;
                        });
            }
            $('#txtEngagement_Code').val(newdata.Engagement_Code.split("|")[0]);

            $('#txtDescription').val(newdata.Description);
            $('#notxt').text(newdata.Id);

             $('#PopupView').modal();
        }
        function Revises() {
            $("#PopupConfirm_Revise").modal();
        }

       function SetTable() {
           var objHeadClRequest = [
               { "title": "Edit", "width": "5%", "className": "dt-center-ctm", "data": "Edit" },
               { "title": "Type of withdrawal", "width": "8%", "className": "dt-center-ctm", "data": "Type_of_withdrawal" },
               { "title": "Name ", "width": "20%", "className": "dt-left-ctm", "data": "Name" },
               { "title": "Submitted Date", "width": "18%", "className": "dt-center-ctm", "data": "daterange" },
               { "title": "Amount ", "width": "3%", "className": "dt-right-ctm", "data": "Amount" },
               { "title": "Charge Code", "width": "20%", "className": "dt-left-ctm", "data": "Engagement_Code" },
               //{ "title": "Approved by", "width": "15%", "className": "dt-left-ctm", "data": "Approve_user" },
               { "title": "Status", "width": "8%", "className": "dt-left-ctm", "data": "approve_status" },
            ];

            var objTableRe = {
                sTableID: "gvwData",
                nDis: [],
                sProperty: "<'row'<'col-sm-6'l><'col-sm-6'f>><'row'<'col-sm-12'tr>><'row'<'col-sm-5'i><'col-sm-7'p>>",//length pangging
                objHeadCl: objHeadClRequest,//Table Headder
                objDataSet: [], //dataset
                nHeadFix: 0,// fix clr
                EmptyTable: EmptyTable,
                order: [[2, "desc"]],
                objBeforeClRender: false,
                //fixedHeader: {
                //    header: true,
                //},
                columnDefs: [
                    {

                        "render": function (data, type, row) {
                            return data == "P" ? "Perdiem" : "Transport";
                        },
                        "targets": 1
                    },
                    {

                        "render": $.fn.dataTable.render.number(',', '.', 2),
                        "targets": 4
                    },

                    {
                        "visible" : false,
                        "render": function (data, type, row) {


                            return data == "Y" ? "<span class='fa fa-circle text-success'></span>&nbsp; Approved" : "<span class='fa fa-circle text-warning'></span>&nbsp; Waiting";
                        },
                        "targets": 6
                    }]
            };
            var table = CreatTableJS(objTableRe);
            //new $.fn.dataTable.FixedHeader($('#gvwData'));
        }

       function Search() {
           var lstSearch = ko.toJS(viewModel)

                return lstSearch;
        };





         function SaveData(Type) {
            var IsPass = true;
            if (IsPass) {
                if (Type == "R" && $('#txtRemark').val() == '' || $('#txtRemark').val() == null )
        {
          DialogWarning(DialogHeader.Warning, "Please enter the reason");
        return false;
        }
                BlockUI();
                objModel.remark = $('#txtRemark').val();
                BindData(objModel);

                var Params = ko.toJS(viewModel);
        var idsub =  $('#notxt').text();
          var Param;
        $.each(Params.lstData, function (key, value) {
                if (value.Id == idsub) { Param = value; }
            });


                var Remark = $('#txtRemark').val();

                $.ajax({
                    dataType: AjaxCall.dataType,
                    type: AjaxCall.type,
                    contentType: AjaxCall.contentType,
                    url: '@Url.Action("SavePerdiem_Transport", "TraineePerdiemTransport")',
                    data: JSON.stringify({ ItemData: Param, type: Type,remark:Remark}),
                    success: function (respone) {
                        if (respone.result.Status == SysProcess.SessionExpired) {
                             PopupLogin('@Url.Action("Login", "Login")');
                        } else if (respone.result.Status == SysProcess.Success) {
                            DialogSuccessOk(DialogHeader.Info, DialogMsg.SaveComplete, 'func', function () {
                                $('#PopupView').modal('hide');
                                $('#txtRemark').val('');
                                var lstData = respone.result.lstData;
                                if (lstData == undefined || lstData.length <= 0) {
                                    $('#gvwData').DataTable().clear().draw();
                                    $('#gvwData').dataTable().fnDraw();
                                    $('#gvwData').DataTable().columns.adjust().draw();
                                    objlstData = [];
                                }
                                else {
                                    $('#gvwData').DataTable().clear().draw();
                                    $('#gvwData').dataTable().fnAddData(lstData);
                                    $('#gvwData').dataTable().fnDraw();
                                    $('#gvwData').DataTable().columns.adjust().draw();
                                    objlstData = lstData;

                                    objModel.lstData = lstData;
                                    BindData(objModel);
                                    //ko.mapping.fromJS(response.result, {}, objModel);
                                } $('#gvwData').DataTable().columns.adjust().draw();

                            });
                        }
                        else if (respone.result.Status == SysProcess.Duplicate) {
                            DialogWarning(DialogHeader.Warning, respone.result.Msg);
                        }
                        else {
                            DialogWarning(DialogHeader.Warning, respone.result.Msg);
                        }
                    },
                    error: AjaxCall.error,
                    complete: function (jqXHR, status) {//finaly
                        UnblockUI();
                    }
                });
            }
            }

        function setReadonly() {
            $("#ddlType_of_reimbursement").attr("readonly", "readonly");
            $("#ddlCompany").attr("readonly", "readonly");
            $("#ddlReimbursable").attr("readonly", "readonly");
            $('#txtAmount').prop('readonly', true);
            $('#txtBusiness_Purpose').prop('readonly', true);
            $('#txtdaterange').prop('readonly', true);
            $('#txtEngagement_Code').prop('readonly', true);
            $('#txtDescription').prop('readonly', true);

            $('#sumdate').prop('readonly', true);
        }
        function LoadData() {
            $('#gvwData').DataTable().columns.adjust().draw();

            var nametxt = $('#txtSearch').val();
            var idtxt = $('#txtSearchNo').val();
            BlockUI();
            $.ajax({
                type: "POST",
                url: '@Url.Action("LoadPerdiemTransportList", "TraineePerdiemTransport")',
                dataType: "json",
                data: { txtname : nametxt, txtid : idtxt },
                success: function (response) {

                    var lstData = response.result.lstData;
                        if (lstData == undefined || lstData.length <= 0) {
                            $('#gvwData').DataTable().clear().draw();
                            $('#gvwData').dataTable().fnDraw();
                            $('#gvwData').DataTable().columns.adjust().draw();
                            objlstData = [];
                        }
                        else {
                            $('#gvwData').DataTable().clear().draw();
                            $('#gvwData').dataTable().fnAddData(lstData);
                            $('#gvwData').dataTable().fnDraw();
                            $('#gvwData').DataTable().columns.adjust().draw();
                            objlstData = lstData;
                            ko.mapping.fromJS(response.result, {}, objModel);
                        }

                },
                complete: function (jqXHR, status) {//finaly
                    $('#gvwData').DataTable().columns.adjust().draw();
                    $('#gvwData').DataTable().columns.adjust().responsive.recalc();
                    UnblockUI();
                }
            });
        }
    </script>
    @*Script for bind Data KnockOut*@
    <script type="text/javascript">
        var viewModel = {

        };
        function ViewModel() {
            var self = this;
            self.conditionChecked = ko.observable(false);
            self.loadCondition = function () {
                //ajax request to get condition value. Suppose ajax request returned value "used". so
                self.conditionChecked("used");
            }
            self.loadCondition();
            ko.bindingHandlers.iCheck = { // integrating icheck plugin using bh

                init: function (element, valueAccessor) {
                    var ctrl = $(element);
                    var sID = ctrl[0].id;
                    //initialize icheck to the element
                    $(element).iCheck({
                        radioClass: 'iradio_flat-green'
                    });
                    $(element).on('ifChecked', function (event) {

                        var observable = valueAccessor();
                        observable.checked(event.target.defaultValue); //assigning selected value

                    });

                },
                update: function (element, valueAccessor) {
                    var observable = valueAccessor();
                }
            };
        }
        function BindData(value) {
            if (viewModel == undefined) {
                viewModel = ko.mapping.fromJS(value);
                ViewModel();

            }
            else {
                ko.mapping.fromJS(value, {}, viewModel);

            }
            if (objModel.lstData != undefined && objModel.lstData != null && objModel.lstData.length > 0) {
                $('#gvwData').DataTable().clear().draw();
                $('#gvwData').dataTable().fnAddData(objModel.lstData);
                $('#gvwData').dataTable().fnDraw();

                setTimeout(function () {
                    $('#gvwData').DataTable().columns.adjust().draw();

                }, 500);
            }
            else {
                $('#gvwData').DataTable().clear().draw();
                $('#gvwData').dataTable().fnDraw();
            }

        }

    </script>
}
<!-- /.content -->
